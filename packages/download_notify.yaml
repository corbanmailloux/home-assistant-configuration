# Package for download notifications

sensor:
  - platform: mqtt
    name: Most Recent Download
    state_topic: "home/obama/downloadcomplete"
  - platform: mqtt
    name: Listing of Waiting Downloads
    state_topic: "emulated/obamadownloads/listing"


binary_sensor:
  - platform: template
    sensors:
      download_waiting:
        friendly_name: Download Waiting
        value_template: >
          {{ states('sensor.listing_of_waiting_downloads') != "" }}
        entity_id: sensor.listing_of_waiting_downloads

automation:
  - alias: "New Obama Download"
    hide_entity: true
    trigger:
      - platform: state
        entity_id: sensor.most_recent_download
    condition:
      condition: and
      conditions:
        - condition: template
          value_template: "{{ trigger.to_state.state != 'none' }}"
        - condition: template
          value_template: "{{ trigger.to_state.state != trigger.from_state.state }}" # Just in case
    action: 
      - service: mqtt.publish
        data:
          topic: "emulated/obamadownloads/listing"
          retain: true
        data_template:
          payload: >
            {%- if states('sensor.listing_of_waiting_downloads') == "" -%}
              {{ trigger.to_state.state }}
            {%- else -%}
              {{ states('sensor.listing_of_waiting_downloads') ~ ', ' ~ trigger.to_state.state }}
            {%- endif -%}
      - delay: 00:00:02
      - service: persistent_notification.create
        data:
          notification_id: 1 # Replace the same notification each time
          title: "Downloads Waiting"
        data_template:
          message: "{{ states('sensor.listing_of_waiting_downloads') }}"

  - alias: "Reset Download Count"
    hide_entity: true
    trigger:
      - platform: state
        entity_id: sensor.most_recent_download
        to: "none"
    action:
      - service: mqtt.publish
        data:
          topic: "emulated/obamadownloads/listing"
          retain: true
          payload: ""

script:
  reset_download_count:
    sequence:
    - service: mqtt.publish
      data:
        topic: "home/obama/downloadcomplete"
        retain: true
        payload: "none"

 
group:
  obama_download_monitor:
    name: Download Monitor
    entities:
      - binary_sensor.download_waiting
      - sensor.most_recent_download
      - sensor.listing_of_waiting_downloads
      - script.reset_download_count


homeassistant:
  customize:
    - entity_id: script.reset_download_count
      friendly_name: Reset Download Count
      icon: mdi:checkbox-marked-circle
