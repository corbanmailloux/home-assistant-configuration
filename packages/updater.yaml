# Sensors and automations for updaters for HASS, HACS, HassOS.
# See https://community.home-assistant.io/t/update-notifications-core-hacs-supervisor-and-addons/182295

sensor:
  # Sensor to track available updates for supervisor & addons
  - platform: command_line
    name: Supervisor Updates
    command: 'curl http://supervisor/supervisor/info -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"newest_version":.data.version_latest,"current_version":.data.version,"update_available":.data.update_available,"addons":[.data.addons[] | select(.update_available)]}'''
    value_template: "{{ value_json.addons | length }}"
    unit_of_measurement: pending update(s)
    json_attributes:
      - update_available
      - newest_version
      - current_version
      - addons

binary_sensor:
  # True if there's updates available for any HACS components or Addons
  - platform: threshold
    name: Updater HACS
    # device_class: problem
    entity_id: sensor.hacs
    upper: 0.5
  - platform: threshold
    name: Updater Addons
    # device_class: problem
    entity_id: sensor.supervisor_updates
    upper: 0.5

  - platform: template
    sensors:
      # True if there's an update available for supervisor
      updater_supervisor:
        friendly_name: "Updater Supervisor"
        device_class: problem
        value_template: "{{ state_attr('sensor.supervisor_updates', 'update_available') }}"
        availability_template: "{{ states('sensor.supervisor_updates') | int(-1) > -1 }}"
