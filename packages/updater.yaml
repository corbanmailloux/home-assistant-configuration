# Sensors and automations for updaters for HASS, HACS, HassOS.
# See https://community.home-assistant.io/t/update-notifications-core-hacs-supervisor-and-addons/182295

alert:
  hass_update_available:
    name: HASS Update Available
    title: Home Assistant Update
    message: Home Assistant version {{ state_attr('binary_sensor.updater', 'newest_version') }} is now available.
    entity_id: binary_sensor.updater
    state: "on"
    repeat: 2880 # 2 days
    notifiers:
      - corban
    data:
      group: "hass_update"
      actions:
        - action: "SILENCE_HASS_UPDATE_ALERT"
          title: "Acknowledge Alert"
          activationMode: "background"
          authenticationRequired: true
          destructive: true
          behavior: "default"
      push:
        sound: none

automation:
  - alias: "Alert Silence - HASS Update"
    id: 872a9e5b-941c-4af4-9da8-7de156440670
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "SILENCE_HASS_UPDATE_ALERT"
    condition:
      - condition: state
        entity_id: alert.hass_update_available
        state: "on"
    action:
      - service: alert.turn_off
        data:
          entity_id: alert.hass_update_available

sensor:
  # Sensor to track available updates for supervisor & addons
  - platform: command_line
    name: Supervisor Updates
    command: 'curl http://supervisor/supervisor/info -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"newest_version":.data.version_latest,"current_version":.data.version,"update_available":.data.update_available,"addons":[.data.addons[] | select(.update_available)]}'''
    value_template: "{{ value_json.addons | length }}"
    unit_of_measurement: pending update(s)
    json_attributes:
      - update_available
      - newest_version
      - current_version
      - addons

binary_sensor:
  # True if there's updates available for any HACS components or Addons
  - platform: threshold
    name: Updater HACS
    device_class: problem
    entity_id: sensor.hacs
    upper: 0.5
  - platform: threshold
    name: Updater Addons
    device_class: problem
    entity_id: sensor.supervisor_updates
    upper: 0.5

  - platform: template
    sensors:
      # True if there's an update available for supervisor
      updater_supervisor:
        friendly_name: "Updater Supervisor"
        device_class: problem
        value_template: "{{ state_attr('sensor.supervisor_updates', 'update_available') }}"
        availability_template: "{{ states('sensor.supervisor_updates') | int(-1) > -1 }}"
# alert:
#   # Update is available - un-acknowledgeble, auto-dismiss, me only
#   # Wait 5 minutes before first to give core config check time to run
#   ha_update_available:
#     name: HA has an update
#     entity_id: binary_sensor.updater
#     state: 'on'
#     can_acknowledge: false
#     repeat:
#     - 5
#     - 360
#     skip_first: true
#     title: 'Update for HA available'
#     message: "New version is {{ state_attr('binary_sensor.updater', 'newest_version') }}. Currently on {{ states('sensor.current_version') }}"
#     notifiers:
#     - 'me'
#     data:
#       tag: 'ha-update-available'
#       url: 'http://hassio.local/hassio/addon/core_check_config'
#       ttl: 21600

#   # Supervisor update is available - un-acknowledgeable, auto-dismiss, me only
#   supervisor_update_available:
#     name: Supervisor has an update
#     entity_id: binary_sensor.updater_supervisor
#     state: 'on'
#     can_acknowledge: false
#     repeat: 360
#     title: 'Update for HA Supervisor available'
#     message: "New version is {{ state_attr('sensor.supervisor_updates', 'newest_version') }}. Currently on {{ state_attr('sensor.supervisor_updates', 'current_version') }}"
#     notifiers:
#     - 'me'
#     data:
#       tag: 'supervisor-update-available'
#       url: 'http://hassio.local/hassio/dashboard'
#       ttl: 21600

#   # HACS repos have updates available - unacknowledgeable, auto-dismiss, me only
#   hacs_update_available:
#     name: HACS repos have updates
#     entity_id: binary_sensor.updater_hacs
#     state: 'on'
#     can_acknowledge: false
#     repeat: 360
#     title: "Updates available in {{ states('sensor.hacs') }} HACS repo{% if states('sensor.hacs') | int > 1 %}s{% endif %}"
#     message: ""
#     notifiers:
#       - 'me'
#     data:
#       tag: 'hacs-update-available'
#       url: 'http://hassio.local/hacs/installed'
#       ttl: 21600

#   # Addons have updates available - unacknowledgeable, auto-dismiss, me only
#   addon_update_available:
#     name: Addons have updates
#     entity_id: binary_sensor.updater_addons
#     state: 'on'
#     can_acknowledge: false
#     repeat: 360
#     title: "Updates available for {{ states('sensor.supervisor_updates') }} HA addon{% if states('sensor.supervisor_updates') | int > 1 %}s{% endif %}"
#     message: ""
#     notifiers:
#     - 'me'
#     data:
#       tag: 'addon-update-available'
#       url: 'http://hassio.local/hassio/dashboard'
#       ttl: 21600
