# If a window is opened while the HVAC is on, disable the HVAC.
# See https://github.com/corbanmailloux/home-assistant-configuration/issues/83.

input_select:
  hvac_interlock_state_machine:
    name: HVAC Interlock - State Machine
    options:
      - "Armed" # Closed windows, HVAC running or stopped
      - "Waiting for close"
      - "Reminding"

input_text:
  hvac_interlock_previous_state:
    name: HVAC Interlock - Previous HVAC State

script:
  # This should probably be moved to a core helpers file.
  flash_light:
    mode: single
    sequence:
      - alias: "Cycle light 'count' times"
        repeat:
          count: "{{ count|int * 2  }}"
          sequence:
            - delay: 0.6
            - service: light.toggle
              target:
                entity_id: "{{ light }}"

  hvac_interlock_dismiss_card:
    alias: HVAC Interlock - Dismiss Reminder
    sequence:
      - alias: "State machine: Move to Armed"
        service: input_select.select_option
        target:
          entity_id: input_select.hvac_interlock_state_machine
        data:
          option: "Armed"

  hvac_interlock_reset_hvac_state:
    alias: HVAC Interlock - Reset HVAC State
    sequence:
      # Do this first to make the UI on the dashboard more responsive.
      - alias: "Move to armed state"
        service: input_select.select_option
        target:
          entity_id: input_select.hvac_interlock_state_machine
        data:
          option: "Armed"
      - alias: "Set HVAC to previous state"
        service: climate.set_hvac_mode
        data_template:
          hvac_mode: "{{ states('input_text.hvac_interlock_previous_state') }}"
        target:
          entity_id: climate.thermostat
      - alias: "Flash couch lamp"
        service: script.flash_light
        data:
          light: light.couch_side_table_lamp
          count: 2

automation:
  ## State machine: Armed

  - alias: HVAC Interlock - Disable HVAC when a window is opened
    id: 84f195d9-2900-44f0-b668-7e9aecf4e18c
    trigger:
      - platform: state
        entity_id: binary_sensor.sliding_door
        from: "off"
        to: "on" # Open
        for: "00:00:30"
    condition:
      - alias: "State machine: Armed"
        condition: state
        entity_id: input_select.hvac_interlock_state_machine
        state: "Armed"
      - condition: not
        conditions:
          - alias: "HVAC on, wrapped in a not"
            condition: state
            entity_id: climate.thermostat
            state: "off"
    action:
      - alias: "Store current HVAC state"
        service: input_text.set_value
        target:
          entity_id: input_text.hvac_interlock_previous_state
        data_template:
          value: "{{ states('climate.thermostat') }}"
      - alias: "Turn off HVAC"
        service: climate.set_hvac_mode
        data:
          hvac_mode: "off"
        target:
          entity_id: climate.thermostat
      - alias: "Flash couch lamp"
        service: script.flash_light
        data:
          light: light.couch_side_table_lamp
          count: 2
      - alias: "State machine: Move to Waiting for close"
        service: input_select.select_option
        target:
          entity_id: input_select.hvac_interlock_state_machine
        data:
          option: "Waiting for close"

  ## State machine: Waiting for close

  - alias: HVAC Interlock - Display HVAC reset card when door is closed
    id: 2e5906e7-59df-4026-98d6-43b1eeb4784b
    trigger:
      - platform: state
        entity_id: binary_sensor.sliding_door
        from: "on"
        to: "off" # Closed
    condition:
      - alias: "State machine: Waiting for close"
        condition: state
        entity_id: input_select.hvac_interlock_state_machine
        state: "Waiting for close"
    action:
      - alias: "State machine: Move to Reminding"
        service: input_select.select_option
        target:
          entity_id: input_select.hvac_interlock_state_machine
        data:
          option: "Reminding"

  - alias: HVAC Interlock - Warn if HVAC is manually enabled with windows open
    id: 6bcac30d-c551-41fe-9217-beb64a7c18c0
    trigger:
      - platform: state
        entity_id: climate.thermostat
        from: "off"
    condition:
      - alias: "State machine: Waiting for close"
        condition: state
        entity_id: input_select.hvac_interlock_state_machine
        state: "Waiting for close"
    action:
      - alias: "Notify Corban"
        service: notify.corban
        data:
          title: "HVAC Enabled with the Door Open"
          message: "Was that intentional? It's possible this breaks the interlock flow. Double-check."
          # TODO: I could add a button to this notification to disable the HVAC directly.

  ## State machine: Reminding

  # Execute button directly executes `script.hvac_interlock_reset_hvac_state` (to "Armed" state.)
  # Dismiss button directly executes `script.hvac_interlock_dismiss_card` (to "Armed" state)

  - alias: HVAC Interlock - Dismiss card if door is opened while reminding
    id: dd09a9cc-06f3-4601-be9b-e4742373f3ba
    trigger:
      - platform: state
        entity_id: binary_sensor.sliding_door
        from: "off"
        to: "on" # Open
    condition:
      - alias: "State machine: Reminding"
        condition: state
        entity_id: input_select.hvac_interlock_state_machine
        state: "Reminding"
    action:
      - alias: "State machine: Move to Waiting for close"
        service: input_select.select_option
        target:
          entity_id: input_select.hvac_interlock_state_machine
        data:
          option: "Waiting for close"

  - alias: HVAC Interlock - Dismiss HVAC card if the HVAC is adjusted manually
    id: 945eed1f-6895-4b18-9c52-71a05c529576
    trigger:
      - platform: state
        entity_id: climate.thermostat
        from: "off"
    condition:
      - alias: "State machine: Reminding"
        condition: state
        entity_id: input_select.hvac_interlock_state_machine
        state: "Reminding"
    action:
      - service: script.hvac_interlock_dismiss_card
