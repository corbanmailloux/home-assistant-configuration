media_player:
  - platform: universal
    name: Living Room TV
    device_class: tv
    children:
      - media_player.plex_living_room_roku_tv
      - media_player.plex_for_living_room_apple_tv
      - media_player.living_room_apple_tv
      - media_player.living_room_chromecast
      - media_player.65_tcl_roku_tv
    commands:
      turn_on:
        service: media_player.turn_on
        data:
          entity_id: media_player.65_tcl_roku_tv
      turn_off:
        service: media_player.turn_off
        data:
          entity_id: media_player.65_tcl_roku_tv
      volume_up:
        service: script.soundbar_volume_up
      volume_down:
        service: script.soundbar_volume_down
      volume_mute:
        service: script.soundbar_power
      select_source:
        service: media_player.select_source
        data_template:
          entity_id: media_player.65_tcl_roku_tv
          source: "{{ source }}"
    attributes:
      source: media_player.65_tcl_roku_tv|source
      source_list: media_player.65_tcl_roku_tv|source_list

switch:
  - platform: template
    switches:
      living_room_tv_power:
        friendly_name: Living Room TV
        icon_template: mdi:television
        value_template: "{{ is_state('remote.living_room_roku_tv', 'on') }}"
        turn_on:
          - service: media_player.turn_on
            data:
              entity_id: media_player.65_tcl_roku_tv
        turn_off:
          - service: media_player.turn_off
            entity_id: media_player.65_tcl_roku_tv

script:
  # Script wrappers for the Roku controls.
  roku_play_pause:
    alias: "Play/Pause"
    icon: mdi:play-pause
    sequence:
      - service: remote.send_command
        data:
          entity_id: remote.living_room_roku_tv
          command: "play"
  roku_replay:
    alias: "Replay"
    icon: mdi:replay
    sequence:
      - service: remote.send_command
        data:
          entity_id: remote.living_room_roku_tv
          command: "replay"
  roku_back:
    alias: "Back"
    icon: mdi:keyboard-backspace
    sequence:
      - service: remote.send_command
        data:
          entity_id: remote.living_room_roku_tv
          command: "back"

  # esphome autoconfigures switches for these. Wrap them in scripts so they appear as buttons in the front end.
  soundbar_volume_up:
    sequence:
      - service: switch.turn_on
        entity_id: switch.soundbar_volume_up
  soundbar_volume_down:
    sequence:
      - service: switch.turn_on
        entity_id: switch.soundbar_volume_down
  soundbar_power:
    sequence:
      - service: switch.turn_on
        entity_id: switch.soundbar_power

automation:
  - alias: Send play/pause to Chromecast when selected
    id: 29bd3071-1a72-45f7-a4f8-7ce8deb7210f
    trigger:
      - platform: event
        event_type: esphome.living_room.play_pause
    condition:
      - condition: template
        value_template: >
          {{ is_state_attr('media_player.65_tcl_roku_tv', 'source', 'Chromecast') }}
    action:
      - service: media_player.media_play_pause
        data:
          entity_id: media_player.living_room_chromecast

  - alias: Switch the TV to the Chromecast when someone starts casting
    id: bf9d5943-b3d9-427b-b028-ac00085b2428
    trigger:
      - platform: state
        entity_id: media_player.living_room_chromecast
        to: "idle"
      - platform: state
        entity_id: media_player.living_room_chromecast
        to: "playing"
    condition:
      - condition: template
        value_template: >
          {{ not is_state_attr('media_player.65_tcl_roku_tv', 'source', 'Chromecast') }}
    action:
      - service: script.living_room_tv_and_soundbar_on
      - service: media_player.select_source
        data:
          entity_id: media_player.65_tcl_roku_tv
          source: Chromecast

  - alias: Turn on the soundbar when the TV turns on
    id: d7bedd79-cc08-4fec-bf25-5971f0fbcaad
    trigger:
      - platform: state
        entity_id: switch.living_room_tv_power
        from: "off"
        to: "on"
    action:
      - service: switch.turn_on
        entity_id: switch.soundbar
